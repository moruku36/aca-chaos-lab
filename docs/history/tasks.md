# Azure Container Apps Chaos Lab - 実装計画

## タスク概要

本ドキュメントは、Azure Container Apps Chaos Labの実装タスクを定義します。各タスクには優先度、依存関係、期待される成果物が記載されています。

## タスクリスト

### 1. 基本インフラストラクチャの構築

#### 1.1 Azure Developer CLI環境の設定
- **説明**: azdプロジェクトの初期設定を行う
- **期待される結果**: 
  - azure.yamlファイルの作成
  - 環境変数の定義
  - プロジェクト構造の確立
- **依存関係**: なし
- **優先度**: 高

#### 1.2 VNetとサブネットの作成
- **説明**: BicepでVNetと2つのサブネットを定義
- **期待される結果**:
  - VNet (10.0.0.0/16)
  - Container Apps サブネット (10.0.0.0/23)
  - Private Endpoint サブネット (10.0.2.0/24)
- **依存関係**: 1.1
- **優先度**: 高

#### 1.3 NSGの作成と初期ルール設定
- **説明**: Container AppsサブネットのNSGを作成
- **期待される結果**:
  - 基本的なインバウンド/アウトバウンドルール
  - 動的ルール追加の準備
- **依存関係**: 1.2
- **優先度**: 高

#### 1.4 Log AnalyticsとApplication Insightsの作成
- **説明**: 監視インフラストラクチャの設定
- **期待される結果**:
  - Log Analytics Workspace
  - Application Insights (パブリックアクセス有効)
- **依存関係**: 1.1
- **優先度**: 高

#### 1.5 Azure Managed Redisの作成
- **説明**: Entra ID認証を有効にしたRedisインスタンスの作成
- **期待される結果**:
  - Redis Cacheインスタンス
  - Entra ID認証の有効化
  - Private Endpointの設定
- **依存関係**: 1.2
- **優先度**: 高

#### 1.6 Container Apps Environmentの作成
- **説明**: VNet統合されたContainer Apps環境の構築
- **期待される結果**:
  - Container Apps Environment
  - VNet統合の完了
  - Log Analytics接続
- **依存関係**: 1.2, 1.4
- **優先度**: 高

### 2. 基本アプリケーションの開発

#### 2.1 プロジェクト構造の作成
- **説明**: Pythonプロジェクトの基本構造を作成
- **期待される結果**:
  - src/ディレクトリ構造
  - pyproject.tomlの作成
  - 開発環境の設定
- **依存関係**: なし
- **優先度**: 高

#### 2.2 FastAPIアプリケーションの基本実装とテスト
- **説明**: 最小限のFastAPIアプリケーションを作成
- **期待される結果**:
  - main.pyの作成
  - 基本的なルーティング
  - ヘルスチェックエンドポイント
  - 単体テストの実装（test_main.py）
- **依存関係**: 2.1
- **優先度**: 高

#### 2.3 Redis接続機能の実装とテスト
- **説明**: Entra ID認証を使用したRedis接続
- **期待される結果**:
  - RedisClientクラスの実装
  - Entra IDトークン取得ロジック
  - 接続プール管理
  - モックを使用した単体テスト
- **依存関係**: 2.2
- **優先度**: 高

#### 2.4 Application Insights統合
- **説明**: テレメトリとログの設定
- **期待される結果**:
  - OpenTelemetry設定
  - カスタムメトリクスの定義
  - ログ出力の実装
- **依存関係**: 2.2
- **優先度**: 高

#### 2.5 Dockerfileの作成
- **説明**: 本番用Dockerイメージの定義
- **期待される結果**:
  - マルチステージビルド
  - 最小限のイメージサイズ
  - セキュアな設定
- **依存関係**: 2.1
- **優先度**: 高

#### 2.6 Container Appのデプロイ設定
- **説明**: BicepでContainer Appリソースを定義
- **期待される結果**:
  - Container App定義
  - Managed Identity設定
  - 環境変数の注入
- **依存関係**: 1.6, 2.5
- **優先度**: 高

### 3. 障害注入機能の実装

#### 3.1 負荷シミュレーションAPIの実装とテスト
- **説明**: CPU/メモリ負荷を生成するエンドポイント
- **期待される結果**:
  - /chaos/loadエンドポイント
  - 負荷レベル制御（低/中/高）
  - タイマー機能
  - 負荷生成ロジックの単体テスト
- **依存関係**: 2.2
- **優先度**: 中

#### 3.2 ハングアップAPIの実装とテスト
- **説明**: アプリケーションを無応答にするエンドポイント
- **期待される結果**:
  - /chaos/hangエンドポイント
  - 永続的/時限的ハング
  - 状態管理
  - タイムアウトのテスト
- **依存関係**: 2.2
- **優先度**: 中

#### 3.3 ステータス確認APIの実装とテスト
- **説明**: 現在の障害状態を確認するエンドポイント
- **期待される結果**:
  - /chaos/statusエンドポイント
  - 全障害状態の取得
  - JSONレスポンス
  - 状態遷移のテスト
- **依存関係**: 3.1, 3.2
- **優先度**: 中

#### 3.4 NSGルール操作スクリプトの作成
- **説明**: Redis通信をブロックするスクリプト
- **期待される結果**:
  - inject-failure.sh (障害注入)
  - restore-normal.sh (復旧)
  - Azure CLI使用
- **依存関係**: 1.3
- **優先度**: 中

#### 3.5 Container Appリビジョン更新スクリプトの作成
- **説明**: 不正なイメージでデプロイ障害を発生させる
- **期待される結果**:
  - デプロイ障害注入スクリプト
  - 正常リビジョンへの復旧スクリプト
- **依存関係**: 2.6
- **優先度**: 中

### 4. 負荷テストツールの開発

#### 4.1 Locust基本シナリオの作成
- **説明**: 基本的な負荷テストシナリオを定義
- **期待される結果**:
  - locustfile.py
  - 基本的なユーザー動作定義
  - エンドポイントテスト
- **依存関係**: 2.2
- **優先度**: 中

#### 4.2 段階的負荷増加シナリオの実装
- **説明**: 徐々にユーザー数を増やすシナリオ
- **期待される結果**:
  - 10分間での段階的増加
  - 0→100→500→1000ユーザー
- **依存関係**: 4.1
- **優先度**: 中

#### 4.3 スパイク負荷シナリオの実装
- **説明**: 瞬間的に大量アクセスを発生させる
- **期待される結果**:
  - 瞬時に5000ユーザー
  - 急激な負荷変動のテスト
- **依存関係**: 4.1
- **優先度**: 中

#### 4.4 負荷テスト実行スクリプトの作成
- **説明**: Locustを簡単に実行するためのスクリプト
- **期待される結果**:
  - run-load-test.sh
  - シナリオ選択機能
  - 結果保存機能
- **依存関係**: 4.1, 4.2, 4.3
- **優先度**: 中

### 5. 統合テストとE2Eテスト

#### 5.1 統合テストの作成
- **説明**: エンドツーエンドのテスト
- **期待される結果**:
  - 実際のRedis接続テスト（テスト環境）
  - 障害注入機能の統合テスト
  - APIワークフローのテスト
- **依存関係**: 3.1, 3.2, 3.3
- **優先度**: 低

### 6. ドキュメントと運用ツール

#### 6.1 READMEの作成
- **説明**: プロジェクトの使用方法を文書化
- **期待される結果**:
  - セットアップ手順
  - 使用方法
  - トラブルシューティング
- **依存関係**: すべてのタスク
- **優先度**: 低

#### 6.2 運用手順書の作成
- **説明**: 障害シナリオの実行手順
- **期待される結果**:
  - 各障害パターンの手順
  - 期待される結果
  - 復旧手順
- **依存関係**: 3.4, 3.5
- **優先度**: 低

#### 6.3 CI/CDパイプラインの設定
- **説明**: GitHub Actionsでの自動化
- **期待される結果**:
  - ビルドワークフロー
  - テスト自動実行
  - デプロイ自動化（オプション）
- **依存関係**: 2.5
- **優先度**: 低

## 実装順序

### フェーズ1: 基礎構築（必須）
1. タスク 1.1 - 1.6: インフラストラクチャ
2. タスク 2.1 - 2.6: 基本アプリケーション（テスト込み）

### フェーズ2: 機能追加（重要）
3. タスク 3.1 - 3.5: 障害注入機能（テスト込み）
4. タスク 4.1 - 4.4: 負荷テストツール

### フェーズ3: 品質向上（推奨）
5. タスク 5.1: 統合テスト
6. タスク 6.1 - 6.3: ドキュメントと自動化

## テスト戦略

### 単体テストの方針
- **実装と同時**: 各機能の実装時に対応するテストを作成
- **TDD推奨**: 可能な限りテストファーストで開発
- **カバレッジ目標**: 各モジュールで80%以上

### テストファイル構造
```
tests/
├── unit/
│   ├── test_main.py
│   ├── test_redis_client.py
│   ├── test_chaos_api.py
│   └── test_load_generator.py
├── integration/
│   └── test_e2e.py
└── conftest.py  # pytest設定とフィクスチャ
```

### モック戦略
- Redis: redis-py-mockまたはカスタムモック
- Entra ID: azure-identityのモック
- 外部API: httpxのモック

## 成功基準

各フェーズの完了基準：

### フェーズ1完了
- [ ] azdでインフラストラクチャをデプロイできる
- [ ] アプリケーションがRedisに接続できる
- [ ] ヘルスチェックが正常に動作する
- [ ] Application Insightsでログが確認できる
- [ ] 基本機能の単体テストがすべてパス

### フェーズ2完了
- [ ] すべての障害パターンを注入できる
- [ ] Locustで負荷テストを実行できる
- [ ] 障害時の動作が期待通りである
- [ ] 障害注入機能の単体テストがすべてパス

### フェーズ3完了
- [ ] 統合テストがすべてパス
- [ ] 80%以上のコードカバレッジ
- [ ] 完全なドキュメント
- [ ] CI/CDパイプラインの動作

## リスクと緩和策

### リスク1: Entra ID認証の複雑性
- **緩和策**: 段階的に実装し、モックを使用した単体テストで動作確認

### リスク2: NSGルール変更の影響
- **緩和策**: 変更前の状態を記録し、即座に復旧できるスクリプトを用意

### リスク3: 負荷テストによる予期しないコスト
- **緩和策**: スケーリング上限を設定し、短時間のテストから開始

### リスク4: テストの実行時間
- **緩和策**: 単体テストと統合テストを分離し、CIでは段階的に実行